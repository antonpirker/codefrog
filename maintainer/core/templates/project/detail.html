{% load static %}
<!doctype html>
<html class="no-js" lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Codefrog - Manage your technical debt. Keep code quality high. Minimize lead time.</title>
        <link rel="stylesheet" href="{% static "css/foundation.min.css" %}">
        <link rel="stylesheet" href="{% static "css/app.css" %} ">
    </head>
    <script type="text/javascript">
        //colors = ['#DD0F7E', '#009BBE', '#A8DA00', '#F2E205', '#EE5A02'];
        colors = ['#DD0F7E', '#009BBE', 'rgba(168, 218, 0, 0.6)', '#F2E205', '#EE5A02'];

        window.onload = function () {
            // CHART JS
            var timeFormat = 'MM/DD/YYYY HH:mm';

            const ctx = document.getElementById('main-chart').getContext('2d');
            const data = {
                // Labels should be Date objects
                labels: [
                    {% for metric in metrics %}
                        moment("{{ metric.date|date:"c" }}").format('YYYY-MM-DD HH:mm:ss'){% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    fill: false,
                    label: 'Complexity',
                    type: 'line',
                    data: [
                        {% for metric in metrics %}
                            {{ metric.complexity|default:0 }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    borderColor: colors[0],
                    backgroundColor: colors[0],
                    pointRadius: 0,
                    lineTension: 0,
                    cubicInterpolationMode: 'monotone',
                    yAxisID: "y-axis-0",
                },{
                    fill: false,
                    label: 'Defects in issue tracker',
                    data: [
                        {% for metric in metrics %}
                            {{ metric.github_bug_issues_now_open|default:0 }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    borderColor: colors[2],
                    backgroundColor: colors[2],
                    lineTension: 0,
                    yAxisID: "y-axis-1",
                },{
                    fill: false,
                    label: 'Avg days to fix defect',
                    data: [
                        {% for metric in metrics %}
                            {{ metric.github_bug_issues_avg_days_open|default:0 }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    borderColor: colors[1],
                    backgroundColor: colors[1],
                    lineTension: 0,
                    yAxisID: "y-axis-2",
                }]
            }

            const releases = [
                {% for release in releases %}
                    {
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: moment("{{ release.timestamp|date:"c" }}").format('YYYY-MM-DD HH:mm:ss'),
                        borderColor: "red",
                        label: {
                            content: "{{ release.name }}",
                            enabled: true,
                            position: "bottom"
                        }
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]

            const options = {
                type: 'bar',
                data: data,
                options: {
                    fill: false,
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        xAxes: [{
                            "id": "x-axis-0",
                            type: 'time',
                            time: {
                                parser: 'YYYY-MM-DD HH:mm:ss',
                                displayFormats: {
                                    day: 'LL',
                                    week: 'ww/YYYY',
                                    month: 'MMM YYYY',
                                    quarter: 'Q YYYY',
                                    year: 'YYYY'
                                },
                            },
                            scaleLabel: {
                                display: true,
                                labelString: "Date",
                            }
                        }],
                        yAxes: [{
                            "id": "y-axis-0",
                            display: false
                        },{
                                "id": "y-axis-1",
                            display: false
                        },{
                            "id": "y-axis-2",
                            display: false
                        }]
                    },
                    legend: {
                        position: 'bottom'
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                enabled: true,
                                drag: true,
                                mode: 'x',
                                speed: 0.1,
                            }
                        }
                    },
                    annotation: {
                        annotations: releases
                    }
                }
            }
            const chart = new Chart(ctx, options);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@0.5.7/chartjs-plugin-annotation.min.js"></script>
</head>

<body>
    <div class="grid-container">
        <!-- Header -->
        <div class="grid-x grid-margin-x grid-padding-y">
            <div class="large-12 cell">
                <a href="{% url 'index' %}">Codefrog</a>
            </div>
        </div>

        <!-- Headline -->
        <div class="grid-x grid-margin-x">
            <div class="large-12 cell">
                <h1>{{ project.name }}</h1>
            </div>
        </div>

        <!-- Trends -->
        <div class="grid-x grid-margin-x">
            <div class="large-12 cell">
                <h2>Trends</h2>
                <p>
                    Zoom:
                    {% if zoom == '1M' %}<b>1M</b>{% else %}<a href="{% url 'project-detail' project.slug %}/1M">1M</a>{% endif %}
                    {% if zoom == '3M' %}<b>3M</b>{% else %}<a href="{% url 'project-detail' project.slug %}/3M">3M</a>{% endif %}
                    {% if zoom == '6M' %}<b>6M</b>{% else %}<a href="{% url 'project-detail' project.slug %}/6M">6M</a>{% endif %}
                    {% if zoom == '1Y' %}<b>1Y</b>{% else %}<a href="{% url 'project-detail' project.slug %}/1Y">1Y</a>{% endif %}
                    {% if zoom == 'YTD' %}<b>YTD</b>{% else %}<a href="{% url 'project-detail' project.slug %}/YTD">YTD</a>{% endif %}
                    {% if zoom == 'ALL' %}<b>ALL</b>{% else %}<a href="{% url 'project-detail' project.slug %}/ALL">ALL</a>{% endif %}
                </p>
                <canvas id="main-chart"></canvas>
            </div>
        </div>
    </div>
</body>
</html>