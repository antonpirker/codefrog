{% extends "../base.html" %}


{% block head_end %}
    <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@0.5.7/chartjs-plugin-annotation.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script type="text/javascript">
        link_color = '#FFAC33';
        color_palette = ['#DD0F7E', '#009BBE', '#A8DA00', '#F2E205', '#EE5A02'];
        chart_colors = ['#DD0F7E', '#0082A5', '#33CEF1'];
        window.onload = function () {
            // CHART JS
            var timeFormat = 'MM/DD/YYYY HH:mm';

            const ctx = document.getElementById('main-chart').getContext('2d');
            const data = {
                // Labels should be Date objects
                labels: [
                    {% for metric in metrics %}
                        moment("{{ metric.date|date:"c" }}").format('YYYY-MM-DD HH:mm:ss'){% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Complexity of the whole System',
                    type: 'line',
                    data: [
                        {% for metric in metrics %}
                            {{ metric.complexity|default:0 }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    fill: false,
                    borderColor: chart_colors[0],
                    borderDash: [10, 5],
                    backgroundColor: chart_colors[0],
                    pointRadius: 4,
                    lineTension: 0,
                    cubicInterpolationMode: 'monotone',
                    yAxisID: "y-axis-0",
                }, {
                    label: 'Open Issues in Issue Tracker',
                    data: [
                        {% for metric in metrics %}
                            {{ metric.github_issues_open|default:0 }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    fill: false,
                    borderColor: chart_colors[1],
                    backgroundColor: chart_colors[1],
                    lineTension: 0,
                    yAxisID: "y-axis-1",
                }, {
                    label: 'Lead Time (Days to Close Issues)',
                    data: [
                        {% for metric in metrics %}
                            {{ metric.github_issue_age|default:0 }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    fill: false,
                    borderColor: chart_colors[2],
                    backgroundColor: chart_colors[2],
                    lineTension: 0,
                    yAxisID: "y-axis-2",
                }]
            };

            const releases = [
                {% for release in releases %}
                    {
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: moment("{{ release.timestamp|date:"c" }}").format('YYYY-MM-DD HH:mm:ss'),
                        borderColor: "red",
                        label: {
                            content: "{{ release.name }}",
                            enabled: true,
                            position: "bottom"
                        }
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            const options = {
                type: 'bar',
                data: data,
                options: {
                    fill: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{
                            "id": "x-axis-0",
                            type: 'time',
                            offset: true,
                            distribution: 'linear',
                            time: {
                                parser: 'YYYY-MM-DD HH:mm:ss',
                                displayFormats: {
                                    day: 'LL',
                                    week: '[Week] WW - YYYY',
                                    month: 'MMM YYYY',
                                    quarter: '[Q]Q - YYYY',
                                    year: 'YYYY'
                                },
                            },
                            scaleLabel: {
                                display: true,
                                labelString: "Date",
                            }
                        }],
                        yAxes: [{
                            "id": "y-axis-0",
                            display: false
                        }, {
                            "id": "y-axis-1",
                            display: false,
                            ticks: {
                                beginAtZero: true
                            }
                        }, {
                            "id": "y-axis-2",
                            display: false,
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    legend: {
                        position: 'bottom'
                    },
                    annotation: {
                        annotations: releases
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function (tooltipItem, data) {
                                const frequency = '{{ frequency }}';
                                const formatStrings = {
                                    'D': 'LL',
                                    'W': '[Week] WW - YYYY',
                                    'M': 'MMM YYYY',
                                    'Q': '[Q]Q - YYYY'
                                };
                                let date = moment(tooltipItem[0].xLabel);
                                title = date.format(formatStrings[frequency] || 'D');
                                return title;
                            },
                            label: function (tooltipItem, data) {
                                const COMPLEXITY = 0;
                                const OPEN_ISSUES = 1;
                                const LEAD_TIME = 2;

                                let out = '';

                                if (tooltipItem.datasetIndex === LEAD_TIME) {
                                    out += 'Lead Time (in Days): ' + tooltipItem.yLabel.toFixed(1);

                                } else if (tooltipItem.datasetIndex === OPEN_ISSUES) {
                                    out += 'Open Issues: ' + tooltipItem.yLabel.toFixed(0);

                                } else if (tooltipItem.datasetIndex === COMPLEXITY) {
                                    out += 'Complexity';
                                }

                                return out;
                            }
                        }
                    }
                }
            };
            const chart = new Chart(ctx, options);
            // TODO: mehrere github apps f√ºr "local"/"staging/ und production?
            // TODO: move JS to .js file (whitenoise?)
            // TODO: make JS function for creating chart in #source-chart-container
            // TODO: add JS function to create ownership chart in #ownership-chart-container

            const dataTree = {{ data_tree|safe }};
            const minChanges = {{ min_changes }};
            const maxChanges = {{ max_changes }};
            createComplexityDiagram("#source-chart-container", dataTree, minChanges, maxChanges);
        }
    </script>
{% endblock head_end %}


{% block content %}
    <div class="grid-container">
        <!-- Bread crumbs -->
        <div class="grid-x grid-margin-x">
            <div class="large-12 cell">
                <a href="{% url 'index' %}">Repositories</a>
                <i class="fas fa-chevron-right" style="color: #999; margin: 0 0.5em;"></i>
                {{ project.github_repo_full_name }}
            </div>

            <div class="large-12 cell">
                &nbsp;
            </div>
        </div>

        <!-- Project Headline -->
        <div class="grid-x grid-margin-x">
            <div class="large-12 cell">
                <h1>{{ project.name }} <small>{% if project.private %}{% endif %}(private)</small></h1>
            </div>
        </div>

        <!-- Project Links -->
        <div class="grid-x grid-margin-x show-for-large">
            <div class="large-12 cell large-text-right">
                {% if project.repo_url %}
                    <a href="{{ project.repo_url }}" target="_blank">Code Repository</a>
                {% endif %}
            </div>
        </div>

        <!-- Status -->
        <div class="grid-x grid-margin-x grid-margin-y dashboard-card">
            <div class="large-4 cell">
                <div class="grid-x">
                    <div class="large-12 cell text-center">
                        {% if current_complexity_change > 0 %}
                            <div class="stat">+{{ current_complexity_change }} %</div>
                        {% else %}
                            <div class="stat">-{{ current_complexity_change }} %</div>
                        {% endif %}

                    </div>
                    <div class="large-12 cell text-center">
                        Complexity Change <i class="fas fa-question-circle" title="The change in complexity of the whole system in the last 30 days."></i>
                    </div>
                </div>
            </div>

            <div class="large-4 cell">
                <div class="grid-x">
                    <div class="large-12 cell text-center">
                        <div class="stat">
                            <a href="{{ project.github_repo_url }}/issues" target="_blank">
                                {{ current_open_tickets }}
                            </a>
                        </div>
                    </div>
                    <div class="large-12 cell text-center">
                        Open Issues
                    </div>
                </div>
            </div>

            <div class="large-4 cell">
                <div class="grid-x">
                    <div class="large-12 cell text-center">
                        <div class="stat">
                            {{ current_lead_time }} days
                        </div>
                    </div>
                    <div class="large-12 cell text-center">
                        Current Lead Time <i class="fas fa-question-circle" title="The number of days between opening an issue in the issue tracker to closing it."></i>
                    </div>
                </div>
            </div>

        </div>

        <!-- Evolution -->
        <div class="grid-x grid-margin-x grid-margin-y dashboard-card">
            <div class="large-12 cell">
                <h2>Evolution</h2>
            </div>

            <div class="large-6 small-6 cell">
                Zoom:
                {% if zoom == '1M' %}<b>1M</b>{% else %}<a href="{% url 'project-detail' project.slug %}/1M">1M</a>{% endif %}
                {% if zoom == '3M' %}<b>3M</b>{% else %}<a href="{% url 'project-detail' project.slug %}/3M">3M</a>{% endif %}
                {% if zoom == '6M' %}<b>6M</b>{% else %}<a href="{% url 'project-detail' project.slug %}/6M">6M</a>{% endif %}
                {% if zoom == '1Y' %}<b>1Y</b>{% else %}<a href="{% url 'project-detail' project.slug %}/1Y">1Y</a>{% endif %}
                {% if zoom == 'YTD' %}<b>YTD</b>{% else %}<a href="{% url 'project-detail' project.slug %}/YTD">YTD</a>{% endif %}
                {% if zoom == 'ALL' %}<b>ALL</b>{% else %}<a href="{% url 'project-detail' project.slug %}/ALL">ALL</a>{% endif %}
            </div>
            <div class="large-5 small-9 cell large-text-right">
                Show releases on chart?
            </div>
            <div class="large-1 small-3 cell text-right">
                <div class="switch tiny">
                    <input class="switch-input" id="show_releases" type="checkbox" name="show_releases" {% if show_releases %}checked{% endif %}>
                    <label class="switch-paddle" for="show_releases">
                        <span class="show-for-sr">Show releases on chart?</span>
                        <span class="switch-active" aria-hidden="true">Yes</span>
                        <span class="switch-inactive" aria-hidden="true">No</span>
                    </label>
                </div>
            </div>

            <div class="large-12 cell" style="padding: 0 1em;">
                <div class="chart-container">
                    <canvas id="main-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Problem Areas -->
        <div class="grid-x grid-margin-x grid-margin-y dashboard-card">
            <div class="large-12 cell">
                <h2>Problem areas</h2>
            </div>

            <!-- Graph -->
            <div class="large-8 cell">
                <div class="grid-x grid-margin-x grid-margin-y">
                    <div class="large-12 cell">
                        <div id="source-chart-container"></div>
                    </div>
                    <!-- Legend -->
                    <div class="large-6 medium-6 small-6 cell">
                        <span class="change_frequency_gradient"></span> <br/>
                        Change frequency
                    </div>
                    <div class="auto cell">
                        <span class=circle1></span>
                        <span class=circle2></span>
                        <span class=circle3></span>
                        <span class=circle4></span>
                        <span class=circle5></span> <br/>
                        Code complexity
                    </div>
                </div>
            </div>
            <div class="large-4 cell">
                <div id="source-information">
                    <h1></h1>
                </div>
            </div>

        </div>
    </div>
{% endblock content %}


{% block body_end %}
    <script>
        var releaseSwitch = document.querySelector('#show_releases');
        releaseSwitch.onclick = function() {
            oldUrl = window.location.href;
            if(releaseSwitch.checked) {
                newUrl = oldUrl.replace('/no-releases', '');
            } else {
                if(!oldUrl.match(/\/no\-releases$/)) {
                    newUrl = oldUrl + '/no-releases';
                } else {
                    newUrl = oldUrl;
                }
            }
            window.location.replace(newUrl);
        };
    </script>
{% endblock body_end %}